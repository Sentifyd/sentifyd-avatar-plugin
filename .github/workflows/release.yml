name: Release WordPress Plugin

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up zip packaging
        run: |
          echo "Preparing plugin package for tag: $GITHUB_REF_NAME"
          PACKAGE_NAME="sentifyd-avatar-plugin-${GITHUB_REF_NAME}.zip"
          # Create zip excluding CI/config/dev artifacts
          zip -r "$PACKAGE_NAME" . \
            -x ".git*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "*.zip" \
            -x "*.tar.gz" \
            -x ".vscode/*" \
            -x "*.log" \
            -x "Thumbs.db" \
            -x ".DS_Store" \
            -x "README.md" # keep readme.txt (WordPress standard)
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Verify archive contents
        run: unzip -l "$PACKAGE_NAME" | head -n 50

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Sentifyd Avatar Plugin ${{ github.ref_name }}"
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: ${{ env.PACKAGE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Prevent multiple simultaneous releases for same tag
    concurrency:
      group: release-${{ github.ref_name }}
      cancel-in-progress: false
