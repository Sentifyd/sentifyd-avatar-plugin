name: Release WordPress Plugin

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up zip packaging
        run: |
          echo "Preparing plugin package for tag: $GITHUB_REF_NAME"
          PLUGIN_SLUG="sentifyd-avatar"
          PACKAGE_NAME="sentifyd-avatar-plugin-${GITHUB_REF_NAME}.zip"
          
          # Create staging directory
          mkdir -p "$PLUGIN_SLUG"
          
          # Copy files excluding dev/build artifacts
          rsync -av . "$PLUGIN_SLUG/" \
            --exclude="$PLUGIN_SLUG" \
            --exclude=".git*" \
            --exclude=".github" \
            --exclude="node_modules" \
            --exclude=".vscode" \
            --exclude="dist" \
            --exclude="build.ps1" \
            --exclude="assets" \
            --exclude="README.md" \
            --exclude="*.zip" \
            --exclude="*.tar.gz" \
            --exclude="*.log" \
            --exclude="Thumbs.db" \
            --exclude=".DS_Store"

          # Zip the staging directory
          zip -r "$PACKAGE_NAME" "$PLUGIN_SLUG"
          
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Verify archive contents
        run: unzip -l "$PACKAGE_NAME" | head -n 50

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Sentifyd Avatar Plugin ${{ github.ref_name }}"
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: ${{ env.PACKAGE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Prevent multiple simultaneous releases for same tag
    concurrency:
      group: release-${{ github.ref_name }}
      cancel-in-progress: false
